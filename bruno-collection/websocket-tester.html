<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crypto Dog WebSocket Tester</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            padding: 30px;
        }
        
        h1 {
            color: #667eea;
            margin-bottom: 10px;
        }
        
        .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        .status.connected {
            background: #10b981;
            color: white;
        }
        
        .status.disconnected {
            background: #ef4444;
            color: white;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .control-group {
            background: #f3f4f6;
            padding: 20px;
            border-radius: 8px;
        }
        
        .control-group h3 {
            margin-bottom: 15px;
            color: #374151;
        }
        
        input, select, button {
            width: 100%;
            padding: 10px;
            margin: 5px 0;
            border: 1px solid #d1d5db;
            border-radius: 5px;
            font-size: 14px;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: background 0.3s;
        }
        
        button:hover {
            background: #5568d3;
        }
        
        button:disabled {
            background: #9ca3af;
            cursor: not-allowed;
        }
        
        .topics {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin: 10px 0;
        }
        
        .topic-btn {
            padding: 8px;
            background: white;
            border: 2px solid #667eea;
            color: #667eea;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .topic-btn.active {
            background: #667eea;
            color: white;
        }
        
        .data-display {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }
        
        .data-panel {
            background: #f9fafb;
            padding: 20px;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .data-panel h3 {
            margin-bottom: 15px;
            color: #374151;
        }
        
        .price-display {
            font-size: 48px;
            font-weight: bold;
            color: #10b981;
            margin: 20px 0;
        }
        
        .candle-info {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }
        
        .info-item {
            background: white;
            padding: 10px;
            border-radius: 5px;
        }
        
        .info-label {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 5px;
        }
        
        .info-value {
            font-size: 18px;
            font-weight: bold;
            color: #111827;
        }
        
        .log-entry {
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-left: 3px solid #667eea;
            border-radius: 3px;
            font-size: 12px;
            font-family: 'Courier New', monospace;
        }
        
        .log-entry.error {
            border-left-color: #ef4444;
            background: #fee;
        }
        
        .trade-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            margin: 5px 0;
            background: white;
            border-radius: 3px;
        }
        
        .trade-buy {
            color: #10b981;
        }
        
        .trade-sell {
            color: #ef4444;
        }
        
        .indicator-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
            margin-top: 10px;
        }
        
        .indicator-controls select {
            padding: 5px 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 10px;
            margin-top: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .indicator-item {
            background: #f8f9fa;
            padding: 8px 12px;
            border-radius: 4px;
            border-left: 3px solid #667eea;
        }
        
        .indicator-name {
            font-weight: bold;
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
        }
        
        .indicator-value {
            font-size: 14px;
            color: #333;
            margin-top: 2px;
        }
        
        .candle-data {
            font-family: monospace;
            font-size: 12px;
            line-height: 1.4;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üêï Crypto Dog WebSocket Tester</h1>
        <span class="status disconnected" id="status">Disconnected</span>
        
        <div class="controls">
            <div class="control-group">
                <h3>Connection</h3>
                <input type="text" id="wsUrl" value="ws://localhost:3000/ws" placeholder="WebSocket URL">
                <button id="connectBtn" onclick="connect()">Connect</button>
                <button id="disconnectBtn" onclick="disconnect()" disabled>Disconnect</button>
            </div>
            
            <div class="control-group">
                <h3>Symbol</h3>
                <select id="symbol">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="SOLUSDT">SOL/USDT</option>
                    <option value="BNBUSDT">BNB/USDT</option>
                    <option value="ADAUSDT">ADA/USDT</option>
                </select>
                <button onclick="subscribeAll()">Subscribe All Topics</button>
            </div>
        </div>
        
        <div class="control-group">
            <h3>Topics</h3>
            <div class="topics">
                <button class="topic-btn" data-topic="tickers" onclick="toggleTopic(this)">Ticker</button>
                <button class="topic-btn" data-topic="kline.1" onclick="toggleTopic(this)">Kline 1m</button>
                <button class="topic-btn" data-topic="kline.5" onclick="toggleTopic(this)">Kline 5m</button>
                <button class="topic-btn" data-topic="kline.15" onclick="toggleTopic(this)">Kline 15m</button>
                <button class="topic-btn" data-topic="kline.60" onclick="toggleTopic(this)">Kline 1h</button>
                <button class="topic-btn" data-topic="publicTrade" onclick="toggleTopic(this)">Trades</button>
                <button class="topic-btn" data-topic="orderbook.25" onclick="toggleTopic(this)">Orderbook 25</button>
                <button class="topic-btn" data-topic="orderbook.50" onclick="toggleTopic(this)">Orderbook 50</button>
            </div>
        </div>
        
        <div class="control-group">
            <h3>üìä Real-time Indicators</h3>
            <div class="indicator-controls">
                <select id="indicatorSymbol">
                    <option value="BTCUSDT">BTC/USDT</option>
                    <option value="ETHUSDT">ETH/USDT</option>
                    <option value="SOLUSDT">SOL/USDT</option>
                </select>
                <select id="indicatorInterval">
                    <option value="1m">1 Minute</option>
                    <option value="5m">5 Minutes</option>
                    <option value="15m" selected>15 Minutes</option>
                    <option value="1h">1 Hour</option>
                    <option value="4h">4 Hours</option>
                    <option value="1d">1 Day</option>
                </select>
                <button onclick="subscribeIndicators()">Subscribe Indicators</button>
                <button onclick="unsubscribeIndicators()">Unsubscribe</button>
                <button onclick="getCurrentCandle()">Get Current Candle</button>
                <button onclick="getIndicators()">Get Indicators</button>
            </div>
        </div>
        
        <div class="data-display">
            <div class="data-panel">
                <h3>Live Price</h3>
                <div class="price-display" id="price">--</div>
                <div class="candle-info" id="candle"></div>
            </div>
            
            <div class="data-panel">
                <h3>Recent Trades</h3>
                <div id="trades"></div>
            </div>
            
            <div class="data-panel">
                <h3>Current Candle</h3>
                <div id="currentCandle">--</div>
            </div>
            
            <div class="data-panel">
                <h3>Indicators</h3>
                <div id="indicators" class="indicators-grid">--</div>
            </div>
        </div>
        
        <div class="data-panel" style="margin-top: 20px;">
            <h3>Message Log</h3>
            <div id="log"></div>
        </div>
    </div>
    
    <script>
        let ws = null;
        let subscribedTopics = new Set();
        
        function connect() {
            const url = document.getElementById('wsUrl').value;
            
            ws = new WebSocket(url);
            
            ws.onopen = () => {
                updateStatus(true);
                addLog('‚úÖ Connected to server');
                document.getElementById('connectBtn').disabled = true;
                document.getElementById('disconnectBtn').disabled = false;
            };
            
            ws.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleMessage(data);
            };
            
            ws.onerror = (error) => {
                addLog('‚ùå Error: ' + error, true);
            };
            
            ws.onclose = () => {
                updateStatus(false);
                addLog('üîå Disconnected from server');
                document.getElementById('connectBtn').disabled = false;
                document.getElementById('disconnectBtn').disabled = true;
                subscribedTopics.clear();
                document.querySelectorAll('.topic-btn').forEach(btn => btn.classList.remove('active'));
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
                ws = null;
            }
        }
        
        function updateStatus(connected) {
            const status = document.getElementById('status');
            if (connected) {
                status.className = 'status connected';
                status.textContent = 'üü¢ Connected';
            } else {
                status.className = 'status disconnected';
                status.textContent = 'üî¥ Disconnected';
            }
        }
        
        function toggleTopic(btn) {
            const topicPrefix = btn.dataset.topic;
            const symbol = document.getElementById('symbol').value;
            const topic = `${topicPrefix}.${symbol}`;
            
            if (subscribedTopics.has(topic)) {
                unsubscribe([topic]);
                subscribedTopics.delete(topic);
                btn.classList.remove('active');
            } else {
                subscribe([topic]);
                subscribedTopics.add(topic);
                btn.classList.add('active');
            }
        }
        
        function subscribeAll() {
            const symbol = document.getElementById('symbol').value;
            const topics = [
                `tickers.${symbol}`,
                `kline.15.${symbol}`,
                `publicTrade.${symbol}`
            ];
            
            subscribe(topics);
            topics.forEach(t => subscribedTopics.add(t));
            
            // Highlight active buttons
            document.querySelectorAll('.topic-btn').forEach(btn => {
                const topic = `${btn.dataset.topic}.${symbol}`;
                if (topics.includes(topic)) {
                    btn.classList.add('active');
                }
            });
        }
        
        function subscribe(topics) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'subscribe',
                    topics: topics,
                    category: 'spot'
                }));
                addLog('üì° Subscribed to: ' + topics.join(', '));
            } else {
                addLog('‚ùå Not connected', true);
            }
        }
        
        function unsubscribe(topics) {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({
                    type: 'unsubscribe',
                    topics: topics
                }));
                addLog('üì° Unsubscribed from: ' + topics.join(', '));
            }
        }
        
        function handleMessage(data) {
            addLog('üì® ' + data.type + ': ' + JSON.stringify(data).substring(0, 100));
            
            if (data.type === 'update' && data.data) {
                const { topic, data: updateData } = data.data;
                
                if (topic?.startsWith('tickers')) {
                    updatePrice(updateData);
                } else if (topic?.startsWith('kline')) {
                    updateCandle(updateData);
                } else if (topic?.startsWith('publicTrade')) {
                    addTrade(updateData);
                }
            } else if (data.type === 'price_update') {
                updatePriceFromIndicator(data);
            } else if (data.type === 'indicators_update') {
                updateIndicators(data);
            } else if (data.type === 'indicators_initial') {
                updateIndicators(data);
                addLog('üìä Initial indicators loaded');
            } else if (data.type === 'current_candle') {
                updateCurrentCandle(data);
            } else if (data.type === 'indicators_snapshot') {
                updateIndicators(data);
                addLog('üìä Indicators snapshot received');
            }
        }
        
        function updatePrice(data) {
            const priceEl = document.getElementById('price');
            if (data && data.lastPrice) {
                priceEl.textContent = '$' + parseFloat(data.lastPrice).toLocaleString();
            }
        }
        
        function updateCandle(data) {
            const candleEl = document.getElementById('candle');
            if (data) {
                candleEl.innerHTML = `
                    <div class="info-item">
                        <div class="info-label">Open</div>
                        <div class="info-value">$${parseFloat(data.open).toLocaleString()}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">High</div>
                        <div class="info-value">$${parseFloat(data.high).toLocaleString()}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Low</div>
                        <div class="info-value">$${parseFloat(data.low).toLocaleString()}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">Close</div>
                        <div class="info-value">$${parseFloat(data.close).toLocaleString()}</div>
                    </div>
                `;
            }
        }
        
        function addTrade(data) {
            const tradesEl = document.getElementById('trades');
            if (data) {
                const tradeClass = data.side === 'Buy' ? 'trade-buy' : 'trade-sell';
                const tradeHtml = `
                    <div class="trade-item">
                        <span class="${tradeClass}">${data.side}</span>
                        <span>$${parseFloat(data.price).toLocaleString()}</span>
                        <span>${data.size}</span>
                    </div>
                `;
                tradesEl.innerHTML = tradeHtml + tradesEl.innerHTML;
                
                // Keep only last 10 trades
                const trades = tradesEl.children;
                while (trades.length > 10) {
                    tradesEl.removeChild(trades[trades.length - 1]);
                }
            }
        }
        
        function addLog(message, isError = false) {
            const logEl = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logClass = isError ? 'log-entry error' : 'log-entry';
            const logHtml = `<div class="${logClass}">[${timestamp}] ${message}</div>`;
            logEl.innerHTML = logHtml + logEl.innerHTML;
            
            // Keep only last 50 log entries
            const logs = logEl.children;
            while (logs.length > 50) {
                logEl.removeChild(logs[logs.length - 1]);
            }
        }
        
        // Indicator functions
        function subscribeIndicators() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('‚ùå Not connected to server', true);
                return;
            }
            
            const symbol = document.getElementById('indicatorSymbol').value;
            const interval = document.getElementById('indicatorInterval').value;
            
            ws.send(JSON.stringify({
                type: 'subscribe_indicators',
                symbol: symbol,
                interval: interval
            }));
            
            addLog(`üìä Subscribing to indicators for ${symbol} ${interval}`);
        }
        
        function unsubscribeIndicators() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('‚ùå Not connected to server', true);
                return;
            }
            
            const symbol = document.getElementById('indicatorSymbol').value;
            const interval = document.getElementById('indicatorInterval').value;
            
            ws.send(JSON.stringify({
                type: 'unsubscribe_indicators',
                symbol: symbol,
                interval: interval
            }));
            
            addLog(`üìä Unsubscribing from indicators for ${symbol} ${interval}`);
        }
        
        function getCurrentCandle() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('‚ùå Not connected to server', true);
                return;
            }
            
            const symbol = document.getElementById('indicatorSymbol').value;
            const interval = document.getElementById('indicatorInterval').value;
            
            ws.send(JSON.stringify({
                type: 'get_current_candle',
                symbol: symbol,
                interval: interval
            }));
            
            addLog(`üïØÔ∏è Requesting current candle for ${symbol} ${interval}`);
        }
        
        function getIndicators() {
            if (!ws || ws.readyState !== WebSocket.OPEN) {
                addLog('‚ùå Not connected to server', true);
                return;
            }
            
            const symbol = document.getElementById('indicatorSymbol').value;
            const interval = document.getElementById('indicatorInterval').value;
            
            ws.send(JSON.stringify({
                type: 'get_indicators',
                symbol: symbol,
                interval: interval
            }));
            
            addLog(`üìä Requesting indicators snapshot for ${symbol} ${interval}`);
        }
        
        function updatePriceFromIndicator(data) {
            const priceEl = document.getElementById('price');
            if (data.price) {
                priceEl.innerHTML = `
                    <div>$${parseFloat(data.price).toLocaleString()}</div>
                    <small>${data.symbol} (${data.interval})</small>
                `;
            }
        }
        
        function updateCurrentCandle(data) {
            const candleEl = document.getElementById('currentCandle');
            if (data.candle && Array.isArray(data.candle)) {
                const [timestamp, open, high, low, close, volume] = data.candle;
                candleEl.innerHTML = `
                    <div class="candle-data">
                        <div>Timestamp: ${new Date(timestamp).toLocaleString()}</div>
                        <div>Open: $${parseFloat(open).toLocaleString()}</div>
                        <div>High: $${parseFloat(high).toLocaleString()}</div>
                        <div>Low: $${parseFloat(low).toLocaleString()}</div>
                        <div>Close: $${parseFloat(close).toLocaleString()}</div>
                        <div>Volume: ${parseFloat(volume).toLocaleString()}</div>
                    </div>
                `;
            }
        }
        
        function updateIndicators(data) {
            const indicatorsEl = document.getElementById('indicators');
            if (data.indicators) {
                let html = '';
                const indicators = data.indicators;
                
                // Sort indicators by name
                const sortedKeys = Object.keys(indicators).sort();
                
                for (const key of sortedKeys) {
                    const value = indicators[key];
                    if (value !== null && value !== undefined) {
                        let displayValue = value;
                        
                        // Format numbers
                        if (typeof value === 'number') {
                            displayValue = value.toFixed(6);
                        } else if (typeof value === 'object') {
                            displayValue = JSON.stringify(value);
                        }
                        
                        html += `
                            <div class="indicator-item">
                                <div class="indicator-name">${key}</div>
                                <div class="indicator-value">${displayValue}</div>
                            </div>
                        `;
                    }
                }
                
                indicatorsEl.innerHTML = html || '<div>No indicators available</div>';
                
                if (data.klineLength) {
                    addLog(`üìä Updated ${sortedKeys.length} indicators (${data.klineLength} candles)`);
                }
            }
        }
    </script>
</body>
</html>
